> 阅读计划：仅读前几章与 Java 和 JVM 无关的计算机虚拟机相关的通用知识篇幅
>
> 笔记详细程度：和《编码 - 藏匿在计算机软硬件背后的语言》笔记同，但本笔记要有截图





# 本书概述

以计算机系统接口抽象层次中两个最重要的接口

- **应用二进制接口（Application Binary Interface，ABI）**
- **应用程序接口（Application Program Interface，API）**

以两者为边界，将计算机系统资源的各种虚拟机技术划分为**进程虚拟机**和**系统虚拟机**两大类展开讨论



内容包括：体系结构，程序设计语言和编译，操作系统，系统安全等。目的在于阐明虚拟机的基本概念和原理，清晰展示虚拟化技术各种方法的各个层面及应用



# 译者序

背景：计算机体系结构迅速发展，系统物理资源大大增加，单点体系结构难以解决系统物理结构的发展带来的一系列问题

为解决这一问题，某佬提出 “计算机科学中的任何问题都可以通过增加一个中间层来解决”



# 前言

本书介绍了对计算机体系结构的理解。按照传统的定义，体系结构就是一个接口。虚拟机把接口连在一起，同时扩大接口的灵活性和功能性。理解体系结构是理解虚拟技术的关键



# 第一章：虚拟机导论

> 引导语：首先引人计算机系统接口的抽象定义，讨论虚拟化与各层接口的关系。然后从计算机体系结构的概念出发，对各种不同类型的虚拟机进行了分类总结，将虚拟机分为两个主要类型：**进程虚拟机**和**系统虚拟机**



**抽象和接口**

管理计算机系统复杂性的关键是通过一些定义明确的接口把计算机系统划分成不同的抽象层次。抽象层次允许忽略或简化系统设计的底层实现细节，从而简化高层组件的设计

例如，硬盘被划分为不同的磁道和扇区，它的细节经过操作系统的抽象，使应用程序看到的硬盘是文件集合而不是盘块和盘块地址



计算机系统的抽象层次通过分层组织，底层由硬件实现，高层由软件实现。在硬件层，所有的组件都是物理的，有真实的特性，各部分通过定义的接口物理地连接在一起。在软件层，组件都是逻辑的，较少受物理特性的限制



**关于如何定义明确的接口来管理计算机资源，下面举个例子**

Intel 设计了实现 IA-32 指令集的 x86 处理器，Microsoft 设计了能把高级语言映射到这个处理器上的编译器

只要这两个设计小组都能够遵从该指令集的规范定义，用此编译器编译好的软件就可以在由 IA-32 处理器组成的机器上正确执行。这两个设计小组遵守的指令集规范也被称为 “接口”



> 能运行这些软件的 “机器”，现在常被称为 “平台”



**接口的局限性**

在硬件/软件接口之下，硬件资源也会限制软件系统的灵活性。许多操作系统是为特定的系统结构开发的，例如是为单处理器或共享存储的多处理器开发的，而且被设计成能直接管理硬件资源

这就意味着，系统的硬件资源是由单一的操作系统管理的。在单一的管理体制下，所有的硬件资源被绑定到单个实体中



**虚拟化**

虚拟化就是把真实系统可以表现为一个不同的虚拟系统或多重的虚拟系统的集合

虚拟化不同于抽象，虚拟化不需要隐藏细节；虚拟系统的细节通常与底层真实系统的细节相同



原文中把虚拟化比作一个函数 V，虚拟系统当前的通过 V 就能映射到真实系统同时刻的状态，而 V 就是虚拟化过程的 “中间步”

<img src="D:\image\readingplan\Snipaste_2021-10-24_21-34-18.png" alt="Snipaste_2021-10-24_21-34-18" style="zoom:25%;" />

此外，还提到了 “同态” 的概念，猜测是 “保证虚拟系统和真实系统表面上拥有相同状态的，由虚拟系统和真实系统以及两者之间的映射关系组成的一个体系”

- 虚拟系统当前的状态通过 V 函数映射到真实系统同时刻的状态
- 用户对虚拟系统执行了操作 e，真实系统执行相应的 e' 操作即可实现 “同态”

虚拟化可被用于处理器（对应虚拟处理器），硬盘（对应虚拟硬盘，如下图），甚至是整个计算机（对应 VM）

<img src="D:\image\readingplan\Snipaste_2021-10-24_21-38-18.png" alt="Snipaste_2021-10-24_21-38-18" style="zoom:25%;" />



VM 通过在真实机器上增加一层软件即可实现虚拟机体系结构。例如在 Win10 上用 VMWare 上安装 Ubuntu 虚拟机



**虚拟机的跨平台性**

经过虚拟化，一个实现 PowerPC 的平台能被转换成一个运行 IA-32 的虚拟平台。为一个平台专门写的软件也能在另一个平台上运行

这种兼容性可以在系统级上提供（Window 上运行 Linux，如 WSL），也能在程序或进程级上提供（MAC 上运行 Office Excel）



虚拟机可以是为真实机器的体系结构构建的，但也可以没有相应的真实机器。比如 JVM。这种方法使得 Java 达到了很高的平台无关性



## 1.1 计算机体系结构

体系结构初现于建筑学，指从建筑物的使用者角度看到的建筑物的外观和功能，而不是建筑物的细节

因此，在计算机中，计算机体系结构指计算机系统或子系统的功能和外观。形式上，体系结构通常由接口规范和接口操纵的资源的逻辑行为来描述

术语 “实现（implementation）” 则用于描述具体的体系结构。每种体系结构都可以有多个实现,每种实现都可以有不同的特征

如下图（<a name="architecture">这个图</a>挺重要的🤔），计算机通过在软硬件上划分层次，并指定各层直接进行通信的接口，实现了计算机体系结构的构建

<img src="D:\image\readingplan\Snipaste_2021-10-25_11-44-08.png" alt="Snipaste_2021-10-25_11-44-08" style="zoom: 50%;" />

<center>数字序号表示各层次之间用于通信的接口</center>

2 是库函数接口；3 是系统调用接口；7 和 8 组成指令集体系结构（ISA，Instruction Set Architecture），ISA 是软硬件的分界。7 是 指令集接口

PS：OS 中指令集分为 用户指令和特权指令，分别在用户态和内核态下执行



> 本书中我们也关注指令集以外的接口
>
> 应用二进制接口 ( Application Binary Inter-face, ABI ) 由接口 3 和 7 组成
>
> - 3：系统调用，间接调用硬件
> - 7：调用指令集直接调用硬件
>
> 应用程序接口 ( Application Program Interface, API )，包括接口 2 和 7
>
> - API 的一个关键部分是标准库（C 语言的 clib 就是一个 C 的标准库）
> - 一些 API 通常由一个或多个 ABI 级的 OS 调用组成或直接由其他 API 组成



## 1.2 虚拟机基础



在了解 “虚拟机” 前要先知道 “机器” 的含义。“机器” 的含义与看待它的角度有关。判断机器的组成成分的依据是：能提供本层次所需服务的所有软硬件都是机器



**机器的概念**

- 从进程角度看，机器由 OS 和底层的用户级硬件组成（因为 OS 和 硬件 给进程提供了内存空间，寄存器使用权，代码执行权）。ABI 提供了进程和机器之间的接口

  <img src="D:\image\readingplan\Snipaste_2021-10-25_15-45-40.png" alt="Snipaste_2021-10-25_15-45-40" style="zoom:50%;" />

- 从 OS 角度看，机器仅由底层硬件实现（整个 OS 由硬件支撑），指令集提供了系统和机器之间的接口

  <img src="D:\image\readingplan\Snipaste_2021-10-25_15-52-58.png" alt="Snipaste_2021-10-25_15-52-58" style="zoom:50%;" />



在 “同态” 中提过，虚拟化过程主要包括两个：

- 把虚拟机器的状态映射到真实机器的状态的过程 V：即虚拟资源，状态和真实资源，状态的映射（比如页式文件管理）
- 和对虚拟机器执行操作序列 e 进行仿真（保持相同状态）的，真实机器执行的操作序列 e'：即仿真。虚拟机执行的操作本质上是真实机器在执行



对机器的认识可以从进程和 OS 两个角度看，所以相应的就有**进程级虚拟机**和**系统级虚拟机**



**进程级虚拟机**

进程需要的服务由机器提供，这个机器可以是真实机器，也可以是虚拟机器

真实机器通过[接口 3，7](#architecture)向进程提供系统调用和指令集调用。如果用虚拟机，进程看到的仅有虚拟机提供的服务

<img src="D:\image\readingplan\Snipaste_2021-10-25_16-19-51.png" alt="Snipaste_2021-10-25_16-19-51" style="zoom:50%;" />

虚拟软件将组成一个平台的 OS 和用户级指令集（应用能直接调用的只能是用户级指令，调特权指令只能通过系统调用间接调用），形成的进程虚拟机能执行为不同 OS 和不同指令集开发的程序（参考 JVM，它令 Java 程序实现了跨平台运行 —— 一次编译，到处撒欢）



虚拟机工作原理（没看懂这些名词，比如虚拟软件和虚拟机的关系）

客户机（运行在虚拟机上的软件）运行在仿真本地机（虚拟机要仿真的真是机器）的虚拟机上，虚拟机运行在主机（底层平台）上

虚拟软件被称为运行时 / 运行时软件，运行时用于支持客户进程（用户进程在虚拟软件上运行）



**系统级虚拟机**





<img src="D:\image\readingplan\Snipaste_2021-10-25_23-20-15.png" alt="Snipaste_2021-10-25_23-20-15" style="zoom:50%;" />

与进程虚拟机不同，系统虚拟机能提供完整的系统环境。它使客户操作能访问底层硬件

如上图，虚拟软件（也叫虚拟机监视器，Virtual Machine Monitor，VMM）仿真硬件 ISA，使传统软件看到一个与硬件支持的 ISA 不同的 ISA

虚拟团建把一个硬件平台上的 ISA 翻译成另一个，以构成系统虚拟机
