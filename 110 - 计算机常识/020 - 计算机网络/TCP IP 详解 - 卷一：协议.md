
# 概述

## 体系结构原则

TCP / IP 体系结构用于满足多种不同的分组交换，这由路由器实现，路由器可以在互不兼容的网络之间提供翻译功能


## 分组、连接和数据报

通过一个例子引出为什么需要分组，连接和数据报这些概念

**最初的通信方式 - 物理连接**

一次电话通话需要为通话双方建立一条连接。通话者在线路的一端输入的数据会沿着某些预先建立的经过交换机的路径到达对端。这条路径就是之前建立的连接

线路是一条通过网络的路径，建立好连接后，线路为一次通话过程而保留。不管是否繁忙，一次通话期间，这条线路只为这次通话传递数据，所以物理连接复用性低

但因为数据的传输路径是固定的，所以数据发送的延迟可预测性强

**提高连接复用性 - 分组**

分组交换思想：把一个完整的数据划分为包含一定字节数的信息块，独立通过网络传输

A 端传给 B 端的一条数据被分成多个分组，每个分组在网络中的传输路径可以不一样。并且数据在发送端 A 处被拆分成分组后，在接收端 B 处能重新组成完整的数据。整个过程被称为 “多路复用”

因为分组传输过程中走的路径是不可预测的，所以数据延迟的可预测性有限


> [!NOTE] 复用手段
> 这里提到了统计复用，和它的替代性技术。例如分时复用和静态复用


**面向连接的分组网络**

分组不一定就是不面向连接的。它只是指把数据拆分成多个后分别发送

如果分组采用虚电路或面向连接的网络，就需要每个交换机中为每个连接保存一些信息或状态。分组到达交换机后，交换机根据分组所属的连接就知道把分组发到哪里

这样每个分组只携带少量的额外信息就能让交换机知道数据要发送给谁


**特殊的分组 - 数据报**

数据报也是分组，但特指包含了数据来源和最终目的地等信息的数据，这样就不需要再交换机中维护连接状态，可以用它来建立无连接的网络

**包含消息长度的分组**

有的分组包含消息边界或记录标记的分组，简单地说就是分组自己知道自己的大小

一般低等协议不保留消息边界，通常都是由上层协议提供这个功能

比如用 TCP 这种流协议通信时，如果要从流数据中完整拆分出每条完整的数据，就需要在读取流数据时知道什么时候读完一条数据，就需要上层实现消息边界功能


## 端到端论点和命运共享

**端到端论点**

这个论点认为重要功能（例如差错控制，加密，交付确认，超时重传）通常不应该在底层实现，而应该在端主机的应用程序中实现

**命运共享**

它指出了选择哪些功能在同一计算机、网络或软件站中实现


## 差错控制和流量控制

**差错控制**

数据在网络传输中难免出现比特位出现差错的问题

- 如果在只有少数位出错的情况下，可以用数学手段检测并修复。这通常在网络中执行
- 当分组发生更严重的损坏时，整个分组通常会被重新发送

有些应用不需要这么严谨的数据，即使比特位中有少量出现差错也没问题。如果分组发生严重损坏时直接把分组丢弃，也不要求重传。所以不是所有的协议都要求实现差错控制

IP 协议是尽力而为交付的服务，不会话费很大的努力确保数据没有差错和缺陷的情况下交付，只会进行简单的校验，即使检测出差错也会直接丢弃数据而不进一步行动



**流量控制**

根据网络阻塞情况和收发数据双方的硬件配置不同，很有可能发送方的发送速率远大于接收方的接收速率，这会导致接收方来不及处理更多的数据而直接丢弃大量分组


TCP 做了流量控制，它会根据在发送速率过快时主动降低发送方的发送速度实现流量控制

这和端到端论点一致：把一些高级功能交给上层协议实现

也可命运共享一致：TCP 会在网络设施中有些单元失效的情况下，不影响网络设备的通信能力


## 分层实现中的复用、分解和封装

分层实现的复用指：协议复用


![Pasted image 20221106173421](https://wings-liberty.oss-cn-beijing.aliyuncs.com/note/Pasted%20image%2020221106173421.png)


物理帧到达网络接口，会根据 “帧类型” 字段判断传递给网络的哪个协议模块，然后此模块处理后通过 IP 首部协议传递给传输层指定的协议模块处理，最后传输层协议模块通过端口号来识别报文段来自于哪个应用

这个过程涉及到了复用协议模块和分发任务给协议模块两个过程

分层的一个重要特点是：在单纯的分层中，不是所有网络设备都需要实现所有层

理论上，端主机需要实现所有层，交换机实现到第 2 层（链路层），路由器实现到第 3 层（网络层）

由于路由器具有互联不同类型的链路层网络的能力，因此它必须位互联网的每种网络实现链路层协议


但通常不遵守这种理论，比如路由器提供了 Web UI、支持远程登录等，那路由器就需要实现所有层


