#还没有复习 

# 服务治理

在传统的rpc远程调用框架中，管理每个服务与服务之间依赖关系比较复杂，管理比较复杂，所以需要使用服务治理，管理服务于服务之间依赖关系，可以实现服务调用、负载均衡、容错等，实现服务发现与注册。



# 服务注册

在服务注册与发现中，有一个注册中心

当服务器启动的时候，会把当前自己服务器的信息 比如 服务地址通讯地址等以别名方式注册到注册中心上

另一方（消费者|服务提供者），以该别名的方式去注册中心上获取到实际的服务通讯地址，然后再实现本地RPC调用

RPC远程调用框架核心设计思想：在于注册中心，因为使用注册中心管理每个服务与服务之间的一个依赖关系(服务治理概念)。在任何rpc远程框架中，都会有一个注册中心(存放服务地址相关信息(接口地址))



服务注册组件中有 3 种角色

- 服务注册中心。单节点注册中心不向自己注册自己。集群下注册中心互相注册，帮助注册中心节点之间建立连接从而形成对外的**一个**注册中心集群
- 消费者。逻辑上来说，消费者不需要注册自己，但需要向注册中心拉取服务节点信息，因为自己使用服务而不向其他服务其提供服务接口，而是向用户（PE，PC客户端用户）提供服务
- 提供者。向注册中心注册，对外暴露自己提供的服务

注册中心也有单节点和集群（线上环境必是集群）



集群原理

- Eureka 集群的原理是 EurekaServer 互相注册



> 看了 Eureka，zk。跳过 Consul



# 负载均衡

**获取**并**维护**服务者列表，并通过负载均衡策略在服务者列表中选一个实例进行调用



> Eureka 默认引入了 Ribbon

Ribbon本地负载均衡客户端 VS Nginx服务端负载均衡区别

Nginx是服务器负载均衡，客户端所有请求都会交给nginx，然后由nginx实现转发请求。即负载均衡是由服务端实现的。（Nginx 面对的客户端是用户的 PC 和 PE，nginx 调用的是集群内的消费者）

 Ribbon本地负载均衡，在调用微服务接口时候，会在注册中心上获取注册信息服务列表之后缓存到JVM本地，从而在本地实现RPC远程服务调用技术。（Ribbon，Sentinel 等负载均衡面对的客户端是 Nginx，它调用的是服务提供者）

**负载均衡分类**

- 集中式 LB：LB 作为独立的服务独立运行。LB 自行和服务提供者通信。收到请求后，自行执行 LB 并选择一台主机。如 nginx，硬件 LB
- 进程内 LB：LB 集成在消费者上，消费者自行获取和维护服务者列表，并通过负载均衡策略在服务者列表中选一个实例进行调用。如 Ribbon

> 学 OpenFeign，跳过 Ribbon



[WebService 是什么](https://blog.csdn.net/hgx_suiyuesusu/article/details/88918192)

- Ribbon  = RestTemplate + LB。用 RestTemplate 调 HTTP 接口
- OpenFeign 和 Ribbon 相比，OpenFeign 通过动态代理调用服务
  - 定义接口，接口方法和服务端的 Controller 提供的方法的方法名相同
  - 给接口上 @Component + @Feign，容器自动完成创建代理对象并加到容器中。直接调接口方法看起来就像在本地调远程 Controller 的方法一样

> OpenFeign 集成了Hystrix 和 Ribbon，提供服务调用，负载均衡，服务降级等多种功能

# 服务降级

服务降级是广义说法，其实际包含 降级，熔断，限流

- 降级表示当前服务忙，需要等待服务调用或直接返回可接受的备选响应
- 熔断表示服务已崩溃，消费者应该对崩溃的服务如何处理。通过服务降级进行熔断
- 限流表示服务忙，请按序等待，服务端每次仅处理一定数量的请求以免服务崩溃

> 服务降级就是服务 A 调用出现异常后，消费者或服务本身直接调用服务降级方法迅速返回一个响应
>
> 服务熔断指服务 A 调用出现异常后如何处理。服务降级是服务熔断的一部分。熔断除了在 A 调用异常时执行服务降级外还包含对服务的监控，以便控制程序在异常什么情况下只执行服务降级，何时恢复服务调用

一个请求涉及多个服务。服务 A 调 B，B 调 C ... 只有有一个崩，这次请求就算失败。服务降级就是在请求失败时给用户返回一个可以接受的备选响应

- Hystrix（豪猪）。虽然停更了，但其设计思想非常完善



> 服务降级可以用在消费端，也可以用在服务端



# 服务网关

用于日志，限流，权限

网关位于 nginx 负载均衡 后。消费者可以集网关，负载均衡，服务熔断与一体。也可以单独部署网关

> 不讲 zuul，不学 zuul

- Spring Cloud Gateway 集成了负载均衡组件



# 服务配置

动态获取远程的 application.yml 服务配置信息

本地使用 bootstrap.yml（优先级最高，application.yml 无法覆盖）



# 消息总线

对服务配置中心功能的加强

通常服务配置和消息总线一块用



# 消息驱动

Spring Cloud Stream 用于封装 MQ，不管用的是哪种 MQ，程序员操作的是 Spring Cloud Stream，而不需要直到到底用的是哪种 MQ

但 Spring Cloud Stream 仅支持 Kafka 和 rabbit



# 链路追踪

追踪服务调用链路

比如记录一次请求实际上涉及了 A 调 B，B 调 C，C 调 D



# Nacos

集成了 ribbon。具有服务注册，配置中心，负载均衡的功能



# 消息队列补充

RabbitMQ 中。一条单播的消息消息会被发送给订阅了这个 topic 的所有组。每个组都收到一条这个消息，但该组中只有一个消费者能收到这条消息

消息持久化的目的：订阅该 topic 的消费者宕机后无法收到新来的消息。但消费者重新上线后，如果其订阅的 topic 没有改变，消费者就能通过持久化的消息获取宕机期间错过的消息
