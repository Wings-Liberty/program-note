# HDFS 概述

Hadoop Distributed File System，简称 HDFS ，是一个分布式文件系统



## HDFS 的架构概述



HDFS 运行时主要由以下几部分组成

- NameNode（nn）：存储文件的元数据。如文件名，文件目录，文件属性，以及每个文件数据所在的 DataNode 地址
- DataNode（dn）：在本地文件系统中存储文件块数据和块数据的校验和
- Secondary NameNode（2nn）：是 NameNode 的备份，每个一段时间就会备份一次

![image-20220625193832098](https://wings-liberty.oss-cn-beijing.aliyuncs.com/note/image-20220625193832098.png)

由此架构可以推出，客户端操作 HDFS 时

- 访问文件时，先访问 nn 获取文件所在的 dn 地址，再访问 dn 读取文件数据
- 创建文件时，先访问 nn 获取新文件被分配的 dn 地址，再把文件数据上传到指定 dn



## HDFS 的优缺点

优点：

- 高容错。sn 备份 nn，dn 又可以有多个备份。服务发现备份丢失后又会创建新的备份，通过增加副本的形式提高了容错性
- 适合大文件存储。能处理大规模的数据量（GB，TB，PB），能处理百万级别的文件数量
- 能在廉价机器上运行

缺点：

- 不适合低延时的数据访问
- 无法高效存储大量的小文件
- 不支持文件的并发写入，和文件的随机修改，仅支持文件内容追加



## HDFS 分块存储

DataNode 把物理空间划分为多个 block 文件块，默认 block 文件块大小为 128M



每个 block 文件块每次读写又是以 150 字节为单位进行写，所以如果存在大量的不到 150 字节的小文件，就会造成空间浪费



# HDFS API

HDFS 作为文件管理系统，其的客户端能执行的指令分为三大类：上传，下载，文件管理



文件管理主要包含：文件的更名，移动，删除，文件和文件夹的判断，读取文件内容，获取文件大小，修改文件权限列表等



# 写数据流程

![image-20220625195108271](https://wings-liberty.oss-cn-beijing.aliyuncs.com/note/image-20220625195108271.png)

1. 客户端向 nn 请求上传文件，nn 检查目标文件是否已存在，父目录是否存在
2. nn 返回是否可以上传
3. 客户端请求第一个 Block 上传到哪几个 dn 服务器
4. nn 返回 若干个 dn 节点
5. 客户端请求 dn1 上传数据，dn1 收到请求会继续调用 dn2，然后 dn2 调用 dn3，将这个通信管道建立完成
6. dn1、dn2、dn3逐级应答客户端
7. 客户端开始往 dn1 上传第一个 Block（先从磁盘读取数据放到一个本地内存缓存），以 Packet 为单位，dn1 收到一个 Packet 就会传给dn2，dn2 传给 dn3；dn1 每传一个 packet 会放入一个应答队列等待应答
8. 当一个 Block 传输完成之后，客户端再次请求 nn 上传第二个Block的服务器（重复执行3-7步）



# 读数据流程

![image-20220625195541005](https://wings-liberty.oss-cn-beijing.aliyuncs.com/note/image-20220625195541005.png)

1. 客户端向 nn 请求下载文件，nn 查询元数据，找到文件块所在的 dn 地址
2. 挑选一台 dn（就近原则，然后随机）服务器，请求读取数据
3. dn 开始传输数据给客户端（从磁盘里面读取数据输入流，以Packet为单位来做校验）
4. 客户端以Packet为单位接收



# nn 和 2nn 备份机制



Q：NameNode中的元数据是存储在哪里的？

A：首先假设，如果存储在 nn 节点的磁盘中，因为经常需要进行随机访问，还有响应客户请求，必然是效率过低。因此，元数据需要存放在内存中。但如果只存在内存中，一旦断电，元数据丢失，整个集群就无法工作了。因此产生在磁盘中备份元数据的 FsImage 文件镜像



Q：这样又会带来新的问题，当在内存中的元数据更新时，如果同时更新 FsImage，就会导致效率过低，但如果不更新，就会发生一致性问题，一旦NameNode节点断电，就会产生数据丢失

A：因此，引入 Edits 文件（只进行追加操作，效率很高）。每当元数据有更新或者添加元数据时，修改内存中的元数据并追加到 Edits 中。这样，一旦NameNode节点断电，可以通过FsImage和Edits的合并，合成元数据。



Q：但是，如果长时间添加数据到 Edits 中，会导致该文件数据过大，效率降低，而且一旦断电，恢复元数据需要的时间过长

A：因此，需要定期进行 FsImage 和 Edits 的合并



Q：如果这个操作由 nn 节点完成，又会效率过低

A：因此，引入一个新的节点 2nn，专门用于 FsImage 和 Edits 的合并



所以得出了 nn 和 2nn 的备份流程如下

![image-20220625200120082](https://wings-liberty.oss-cn-beijing.aliyuncs.com/note/image-20220625200120082.png)

- 对 nn 中数据写操作：写内存，同时把修改顺序写在 edits 文件
- 2nn 在合适的时机获取  nn 的 fsimage 和 edits 文件并能执行合并，把得到的新 fsimage 传给 nn
