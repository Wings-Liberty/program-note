

# 问题描述

新的全局常量没入库，给节点的输入参数赋值时不能指定全局变量的 id 作为参数的值


# 方案一：临时 ID

解决方案：不改字段，由前端给新增的全局常量一个临时 id，这个 `tmpId` 用于在请求体里定义全局常量，以及在其他地方引用全局常量

Step1：新增全局常量后，由给全局常量的 `tmpId` 属性赋值，要求新增的全局常量之间 `tmpId` 不能有重复

```json
"globalList": [
	{
		"id": 111,
		"name": "全局常量1", // 之前就有的
		"value": "值1"
	},
	{
		"tmpId": 222,
		"name": "新增全局常量2", // 这次新增的
		"value": "值2"
	}
]
```

Step2：为动作选择输入参数的值时，全局变量的下拉列表里应该展示已有的和新增的（此时新增的还没有入库，所以没有 id）


Step3：保存剧本时用 `tmpId` 给条件或动态变量赋值

给条件赋值

```json
"conditionalList": [
	{
		"nodeId": "sid_10",
		"leftOrigin": 0,
		"leftId": 999,
		"operator": 2,
		"rightOrigin": 2,
		"rightTmpId": 222 // 前端为全局变量生成的临时 id
	}
]
```

给动作需要的参数赋值

```json
"paramAssignmentList": [
	{
		"nodeId": "sid_123_423_d8u_342",
		"actionVariableId": 888,
		"valueOrigin": 2, // 全局常量
		"valueTmpId": 222 // 值来自其他变量
	}
]
```

**后端实现步骤**

1. 收到参数
2. 保存策略
3. 保存新增常量
4. 保存

还需要解决一个问题：页面上删除一个全局常量时不会调用删除接口，但展示全局常量时需要不展示那些被删除的项，这需要前端做额外的工作

# 方案二：临时表方案

添加全局常量时就调接口，让全局常量入库。但新入库的全局常量不是真入库，等保存策略时，让全局常量真入库

setp1：添加全局常量，调接口入库

```json
{
	"name": "全局常量3",
	"value": "全局常量值3",
	"tmpId": 555
}
```

| id  | 全局常量名称 | 全局常量值  | 策略id | 临时 id |
| --- | ------------ | ----------- | ------ | ------- |
| 000 | 全局常量0    | 全局常量值0 | 222    |         |
| 111 | 全局常量1    | 全局常量值1 |        | 333     |
| 444 | 全局常量2    | 全局常量值2 |        | 555     |
| 666 | 全局常量3    | 全局常量值3 |        | 555     |

PS：临时 id 由前端生成，要求在创建一个策略时新增常量携带的临时 id 相同，创建不同策略时，临时 id 不能相同

step2：查询可用的全局常量时调用接口

查询全局常量需要传参：策略 id，临时 id。

比如传：`tactics=222, tmpId=555` 会查到以下结果

| id  | 全局常量名称 | 全局常量值  | 策略id | 临时 id |
| --- | ------------ | ----------- | ------ | ------- |
| 000 | 全局常量0    | 全局常量值0 | 222    |         |
| 444 | 全局常量2    | 全局常量值2 |        | 555     |
| 666 | 全局常量3    | 全局常量值3 |        | 555     |

step3：用全局常量，在条件分支给条件赋值，在动作节点给运行参数赋值

把全局常量的 id 正常作为 right_id 的值给条件分支赋值和动作的运行参数赋值

step4：保存策略，发送请求

1. 保存策略到 `tb_soar_tactics`（策略主表）
2. ==把新增的全局常量的临时id去掉==（视为真正把全局常量绑定到策略里）
3. 存到条件详情表，动态参数赋值表.....

但还会存在这个问题：页面上删除一个全局常量时不会调用删除接口，但展示全局常量时需要不展示那些被删除的项，这需要前端做额外的工作。实现难度和方案一相同

缺点：表里会保存更多没用的数据，比如新增了一些全局常量，但因为没有保存策略，所以新增的全局常量都留了下来

# 页面上删除全局常量不调接口，但展示全局常量时不展示那些被删除的项


方案一和方案二都有这个问题需要解决，这个需要由前端解决。且==这个问题的解决方式和实现难度和我选择了方案一还是方案二无关==

建议实现方式：

前端调用**查询全局常量列表后存到数组里**

**对全局常量 curd 需要同步到数组里**

在条件分支或动作节点里**查询有哪些可用的全局常量时，从数组里取数据即可**

